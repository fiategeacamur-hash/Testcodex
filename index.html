<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini 2D Game Engine & IDE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #60a5fa;
      --muted: #94a3b8;
      --border: #1e293b;
      --text: #e2e8f0;
      --danger: #ef4444;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: #0b1220;
    }
    header h1 { margin: 0; font-size: 18px; letter-spacing: 0.5px; }
    .btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 120ms ease, border 120ms ease, transform 120ms ease;
    }
    .btn:hover { background: #1f2937; }
    .btn.play { background: var(--success); color: #0b1220; border-color: #16a34a; }
    .btn.stop { background: var(--danger); color: #fff; border-color: #b91c1c; }
    .btn.small { padding: 6px 8px; font-size: 12px; }
    main {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1.3fr;
      gap: 10px;
      padding: 10px;
      height: calc(100vh - 56px);
      overflow: hidden;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    .panel h3 {
      margin: 0;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      font-size: 14px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    #editor-tabs { display: flex; gap: 6px; padding: 10px; border-bottom: 1px solid var(--border); overflow-x: auto; }
    #editor-tabs button {
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    #editor-tabs button.active { background: var(--accent); color: #0b1220; border-color: #1d4ed8; }
    #code { flex: 1; overflow: hidden; }
    .CodeMirror { height: 100%; background: #0b1220; color: #e2e8f0; }
    .CodeMirror-gutters { background: #0b1220; border-right: 1px solid var(--border); }
    #file-actions { display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--border); }
    #hierarchy { flex: 1; overflow: auto; padding: 10px; }
    #hierarchy ul { list-style: none; padding: 0; margin: 0; }
    #hierarchy li {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 6px;
      background: #0b1220;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #hierarchy li.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(96,165,250,0.2); }
    #inspector { flex: 1; overflow: auto; padding: 10px; display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
    #inspector label { font-size: 12px; color: var(--muted); }
    #inspector input, #inspector select {
      width: 100%;
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      color: var(--text);
    }
    #assets { padding: 10px; display: grid; grid-template-columns: repeat(auto-fit,minmax(100px,1fr)); gap: 8px; }
    .asset-card { border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: #0b1220; text-align: center; }
    .asset-card img { width: 64px; height: 64px; border-radius: 6px; border: 1px solid var(--border); object-fit: cover; }
    #game-panel { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    #game-view { background: #0b1220; border-bottom: 1px solid var(--border); position: relative; }
    #game-view iframe { width: 100%; height: 100%; border: none; background: #0b1220; }
    #console { background: #000; color: #0f0; font-family: "Fira Code", monospace; font-size: 12px; padding: 8px; overflow: auto; height: 150px; }
    #scene-toolbar { display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border); }
    .tag { padding: 2px 6px; border-radius: 6px; font-size: 11px; background: rgba(255,255,255,0.08); color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <h1>Browser Mini Game Engine & IDE</h1>
      <span class="tag">Single HTML</span>
      <span class="tag">Hot Reload</span>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn play" id="play-btn">â–¶ Play</button>
      <button class="btn stop" id="stop-btn">â–  Stop</button>
    </div>
  </header>
  <main>
    <section class="panel" id="left">
      <div id="editor-tabs"></div>
      <div id="code"><textarea id="code-area"></textarea></div>
      <div id="file-actions">
        <button class="btn" id="save-btn">ðŸ’¾ Save</button>
        <button class="btn" id="add-file-btn">âž• New File</button>
      </div>
      <h3>Assets</h3>
      <div id="assets"></div>
    </section>
    <section class="panel" id="middle">
      <div id="scene-toolbar">
        <button class="btn small" id="new-entity-btn">ï¼‹ New Entity</button>
        <span class="tag">Drag to reorder</span>
      </div>
      <div style="display:grid; grid-template-rows: 1fr 1fr; min-height:0;">
        <div>
          <h3>Scene Hierarchy</h3>
          <div id="hierarchy"></div>
        </div>
        <div>
          <h3>Inspector</h3>
          <div id="inspector"></div>
        </div>
      </div>
    </section>
    <section class="panel" id="right">
      <div id="game-panel">
        <div id="game-view"></div>
        <h3 style="margin:0;border-top:1px solid var(--border);">Console</h3>
        <div id="console"></div>
      </div>
    </section>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script>
    // Virtual project files with default demo content
    const projectFiles = {
      "main.js": `// Main entry
registerMain(({ Engine, Scene, Entity, Components, Assets, initialScene, helpers }) => {
  const canvas = document.getElementById('game');
  const scene = new Scene('Demo');
  // Use helper to build entities from editor data
  helpers.populateScene(initialScene, scene);
  Engine.start(canvas, scene);
});`,
      "player.js": `// Player behavior
exports.onStart = (entity, { Components }) => {
  entity.addComponent('RigidBody', { gravity: 1000, friction: 0.9 });
  entity.addComponent('KeyboardInput', {});
};

exports.onUpdate = (entity, dt, ctx) => {
  const rb = entity.getComponent('RigidBody');
  const input = entity.getComponent('KeyboardInput');
  const speed = 200;
  if (input.left) rb.velocity.x = -speed;
  else if (input.right) rb.velocity.x = speed;
  else rb.velocity.x *= 0.8;
  if (input.jump && rb.onGround) {
    rb.velocity.y = -400;
    rb.onGround = false;
  }
};

exports.onCollisionEnter = (entity, other) => {
  if (other.name.startsWith('Hay')) {
    entity.money = (entity.money || 0) + 1;
    other.destroyed = true;
    console.log('Money:', entity.money);
  }
};`,
      "hay.js": `// Hay bale behavior
exports.onStart = (entity) => {
  // Static hay
};
`};

    // Simple asset list (virtual filesystem)
    const assetLibrary = {
      player: 'data:image/svg+xml;base64,' + btoa(`<svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="64" rx="10" fill="#60a5fa"/><path d="M18 28h28v8H18z" fill="#0b1220"/><circle cx="24" cy="20" r="6" fill="#0b1220"/></svg>`),
      hay: 'data:image/svg+xml;base64,' + btoa(`<svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="64" rx="8" fill="#facc15"/><path d="M14 20h36v4H14zM14 30h36v4H14zM14 40h36v4H14z" stroke="#854d0e" stroke-width="2" fill="#fef08a"/></svg>`),
      ground: 'data:image/svg+xml;base64,' + btoa(`<svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="64" rx="4" fill="#16a34a"/><path d="M0 40h64v24H0z" fill="#14532d"/></svg>`)
    };

    // Scene entity data used by editor and sent to runtime
    let entities = [
      { id: crypto.randomUUID(), name: 'Player', x: 80, y: 300, rotation: 0, scaleX: 1, scaleY: 1, sprite: 'player', collider: { w: 32, h: 32 }, script: 'player.js' },
      { id: crypto.randomUUID(), name: 'Hay1', x: 260, y: 320, rotation: 0, scaleX: 1, scaleY: 1, sprite: 'hay', collider: { w: 40, h: 30 }, script: 'hay.js' },
      { id: crypto.randomUUID(), name: 'Hay2', x: 340, y: 320, rotation: 0, scaleX: 1, scaleY: 1, sprite: 'hay', collider: { w: 40, h: 30 }, script: 'hay.js' },
      { id: crypto.randomUUID(), name: 'Hay3', x: 420, y: 320, rotation: 0, scaleX: 1, scaleY: 1, sprite: 'hay', collider: { w: 40, h: 30 }, script: 'hay.js' },
      { id: crypto.randomUUID(), name: 'Ground', x: 0, y: 360, rotation: 0, scaleX: 1, scaleY: 1, sprite: 'ground', collider: { w: 800, h: 40 }, script: '' }
    ];

    let activeFile = 'main.js';
    let cm;
    let iframeRef = null;

    function initCodeEditor() {
      cm = CodeMirror.fromTextArea(document.getElementById('code-area'), {
        mode: 'javascript',
        theme: 'darcula',
        lineNumbers: true,
        tabSize: 2,
        indentUnit: 2,
        lineWrapping: true,
      });
      loadFile(activeFile);
    }

    function renderTabs() {
      const tabBar = document.getElementById('editor-tabs');
      tabBar.innerHTML = '';
      Object.keys(projectFiles).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.className = name === activeFile ? 'active' : '';
        btn.onclick = () => { saveCurrent(); activeFile = name; loadFile(name); renderTabs(); };
        tabBar.appendChild(btn);
      });
    }

    function loadFile(name) {
      cm.setValue(projectFiles[name]);
    }

    function saveCurrent() {
      projectFiles[activeFile] = cm.getValue();
      logConsole(`Saved ${activeFile}`);
    }

    function renderAssets() {
      const wrapper = document.getElementById('assets');
      wrapper.innerHTML = '';
      Object.entries(assetLibrary).forEach(([name, url]) => {
        const card = document.createElement('div');
        card.className = 'asset-card';
        card.innerHTML = `<img src="${url}" alt="${name}"/><div>${name}</div>`;
        wrapper.appendChild(card);
      });
    }

    function renderHierarchy() {
      const container = document.getElementById('hierarchy');
      const ul = document.createElement('ul');
      entities.forEach((e, idx) => {
        const li = document.createElement('li');
        li.textContent = e.name;
        li.dataset.id = e.id;
        li.draggable = true;
        li.onclick = () => selectEntity(e.id);
        li.ondragstart = (ev) => { ev.dataTransfer.setData('text/plain', idx); };
        li.ondragover = (ev) => ev.preventDefault();
        li.ondrop = (ev) => {
          ev.preventDefault();
          const from = parseInt(ev.dataTransfer.getData('text/plain'), 10);
          const to = idx;
          const [moved] = entities.splice(from, 1);
          entities.splice(to, 0, moved);
          renderHierarchy();
        };
        if (selectedEntity && selectedEntity.id === e.id) li.classList.add('selected');
        ul.appendChild(li);
      });
      container.innerHTML = '';
      container.appendChild(ul);
    }

    let selectedEntity = null;
    function selectEntity(id) {
      selectedEntity = entities.find(e => e.id === id);
      renderHierarchy();
      renderInspector();
    }

    function renderInspector() {
      const insp = document.getElementById('inspector');
      insp.innerHTML = '';
      if (!selectedEntity) {
        insp.innerHTML = '<div style="grid-column: span 2;color:var(--muted);">Select an entity to edit its properties.</div>';
        return;
      }
      const fields = [
        ['Name', 'name'], ['X', 'x'], ['Y', 'y'], ['Rotation', 'rotation'], ['Scale X', 'scaleX'], ['Scale Y', 'scaleY']
      ];
      fields.forEach(([label, key]) => {
        const wrap = document.createElement('div');
        wrap.innerHTML = `<label>${label}</label>`;
        const input = document.createElement('input');
        input.value = selectedEntity[key];
        input.oninput = (e) => { selectedEntity[key] = parseFloat(e.target.value) || 0; };
        wrap.appendChild(input);
        insp.appendChild(wrap);
      });

      const spriteWrap = document.createElement('div');
      spriteWrap.innerHTML = '<label>Sprite</label>';
      const spriteSelect = document.createElement('select');
      Object.keys(assetLibrary).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; if (selectedEntity.sprite === name) opt.selected = true; spriteSelect.appendChild(opt);
      });
      spriteSelect.onchange = (e) => { selectedEntity.sprite = e.target.value; };
      spriteWrap.appendChild(spriteSelect);
      insp.appendChild(spriteWrap);

      const colW = document.createElement('div');
      colW.innerHTML = '<label>Collider W</label>';
      const colWInput = document.createElement('input');
      colWInput.value = selectedEntity.collider?.w || 0;
      colWInput.oninput = (e) => { selectedEntity.collider = selectedEntity.collider || {}; selectedEntity.collider.w = parseFloat(e.target.value) || 0; };
      colW.appendChild(colWInput);
      insp.appendChild(colW);

      const colH = document.createElement('div');
      colH.innerHTML = '<label>Collider H</label>';
      const colHInput = document.createElement('input');
      colHInput.value = selectedEntity.collider?.h || 0;
      colHInput.oninput = (e) => { selectedEntity.collider = selectedEntity.collider || {}; selectedEntity.collider.h = parseFloat(e.target.value) || 0; };
      colH.appendChild(colHInput);
      insp.appendChild(colH);

      const scriptWrap = document.createElement('div');
      scriptWrap.style.gridColumn = 'span 2';
      scriptWrap.innerHTML = '<label>Script File</label>';
      const scriptSelect = document.createElement('select');
      const emptyOpt = document.createElement('option'); emptyOpt.value = ''; emptyOpt.textContent = 'None'; scriptSelect.appendChild(emptyOpt);
      Object.keys(projectFiles).forEach(name => {
        const opt = document.createElement('option'); opt.value = name; opt.textContent = name; if (selectedEntity.script === name) opt.selected = true; scriptSelect.appendChild(opt);
      });
      scriptSelect.onchange = (e) => { selectedEntity.script = e.target.value; };
      scriptWrap.appendChild(scriptSelect);
      insp.appendChild(scriptWrap);
    }

    function addEntity() {
      const id = crypto.randomUUID();
      const entity = { id, name: 'Entity ' + (entities.length + 1), x: 100, y: 100, rotation: 0, scaleX: 1, scaleY: 1, sprite: 'player', collider: { w: 32, h: 32 }, script: '' };
      entities.push(entity);
      selectEntity(id);
      renderHierarchy();
    }

    function logConsole(msg) {
      const consoleEl = document.getElementById('console');
      const line = document.createElement('div');
      line.textContent = msg;
      consoleEl.appendChild(line);
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    // Game runtime injection into sandboxed iframe
    function playGame() {
      saveCurrent();
      if (iframeRef) stopGame();
      const iframe = document.createElement('iframe');
      iframe.sandbox = 'allow-scripts';
      iframeRef = iframe;
      const gameView = document.getElementById('game-view');
      gameView.innerHTML = '';
      gameView.appendChild(iframe);
      const src = buildIframeContent();
      iframe.srcdoc = src;
      logConsole('Game started');
    }

    function stopGame() {
      if (iframeRef) {
        iframeRef.remove();
        iframeRef = null;
        logConsole('Game stopped');
      }
    }

    window.addEventListener('message', (event) => {
      if (event.data?.type === 'console') {
        logConsole(event.data.message);
      }
    });

    function buildIframeContent() {
      const scriptsJSON = JSON.stringify(projectFiles).replace(/<\//g, '<\\/');
      const entitiesJSON = JSON.stringify(entities).replace(/<\//g, '<\\/');
      const assetsJSON = JSON.stringify(assetLibrary).replace(/<\//g, '<\\/');
      return `<!DOCTYPE html>
<html><head><style>
html,body{margin:0;padding:0;overflow:hidden;background:#0b1220;}
canvas{width:100vw;height:100vh;display:block;background:#0b1220;}
</style></head><body><canvas id="game"></canvas>
<script>
// Console bridge
(function(){
  const send=(type,args)=>parent.postMessage({type:'console',message:args.join(' ')},'*');
  ['log','warn','error'].forEach(fn=>{
    const orig=console[fn];
    console[fn]=(...args)=>{send('console',args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)));orig.apply(console,args);};
  });
})();

const projectFiles = ${scriptsJSON};
const initialScene = ${entitiesJSON};
const assetData = ${assetsJSON};

// Math utilities
class Vector2 { constructor(x=0,y=0){this.x=x;this.y=y;} add(v){this.x+=v.x;this.y+=v.y;return this;} clone(){return new Vector2(this.x,this.y);} }
class Rect { constructor(x=0,y=0,w=0,h=0){this.x=x;this.y=y;this.w=w;this.h=h;} }
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const distance=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

// Asset Manager
const Assets = { images:{}, loadImage(name,url){return new Promise(res=>{const img=new Image();img.onload=()=>{this.images[name]=img;res(img);};img.src=url;});}, getImage(name){return this.images[name];} };
Object.entries(assetData).forEach(([n,u])=>Assets.loadImage(n,u));

// Core Engine
const Engine = {
  canvas:null, ctx:null, currentScene:null, running:false, _last:0, timeScale:1, _raf: null,
  start(canvas, scene){
    this.canvas=canvas;this.ctx=canvas.getContext('2d');
    this.currentScene=scene; this.running=true; this._last=performance.now();
    scene.load();
    const loop=(now)=>{if(!this.running) return; const dt=(now-this._last)/1000*this.timeScale; this._last=now; scene.update(dt); scene.draw(this.ctx); this._raf=requestAnimationFrame(loop);};
    this._raf=requestAnimationFrame(loop);
  },
  stop(){ this.running=false; if(this._raf) cancelAnimationFrame(this._raf); }
};

class Scene {
  constructor(name='Scene'){this.name=name;this.entities=[];}
  addEntity(e){this.entities.push(e);} removeEntity(e){this.entities=this.entities.filter(x=>x!==e);} findByName(name){return this.entities.find(e=>e.name===name);} load(){this.entities.forEach(e=>e.start());}
  update(dt){
    // Update components
    this.entities.forEach(e=>e.update(dt));
    // Collision detection
    for(let i=0;i<this.entities.length;i++){
      for(let j=i+1;j<this.entities.length;j++){
        const a=this.entities[i], b=this.entities[j];
        if(a.destroyed||b.destroyed) continue;
        const colA=a.getComponent('BoxCollider');
        const colB=b.getComponent('BoxCollider');
        if(colA&&colB){
          const ra=colA.getRect(); const rb=colB.getRect();
          if(ra.x < rb.x+rb.w && ra.x+ra.w > rb.x && ra.y < rb.y+rb.h && ra.y+ra.h > rb.y){
            a.components.forEach(c=>c.onCollisionEnter&&c.onCollisionEnter(b));
            b.components.forEach(c=>c.onCollisionEnter&&c.onCollisionEnter(a));
          }
        }
      }
    }
    // Remove destroyed
    this.entities = this.entities.filter(e=>!e.destroyed);
  }
  draw(ctx){
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    this.entities.forEach(e=>e.draw(ctx));
  }
}

class Entity {
  constructor(name='Entity'){
    this.name=name;
    this.transform={x:0,y:0,rotation:0,scaleX:1,scaleY:1};
    this.components=[];
  }
  addComponent(type, config={}){
    let comp=null;
    switch(type){
      case 'SpriteRenderer': comp=new SpriteRenderer(this,config); break;
      case 'RigidBody': comp=new RigidBody(this,config); break;
      case 'BoxCollider': comp=new BoxCollider(this,config); break;
      case 'Script': comp=new ScriptComponent(this,config); break;
      case 'KeyboardInput': comp=new KeyboardInput(this,config); break;
    }
    if(comp){this.components.push(comp);} return comp;
  }
  getComponent(type){return this.components.find(c=>c.type===type);}
  start(){this.components.forEach(c=>c.start&&c.start());}
  update(dt){this.components.forEach(c=>c.update&&c.update(dt));}
  draw(ctx){this.components.forEach(c=>c.draw&&c.draw(ctx));}
}

class SpriteRenderer {
  constructor(entity,{sprite=''}={}){this.entity=entity; this.type='SpriteRenderer'; this.sprite=sprite; this.color='#64748b';}
  draw(ctx){
    ctx.save();
    ctx.translate(this.entity.transform.x,this.entity.transform.y);
    ctx.rotate(this.entity.transform.rotation*Math.PI/180);
    ctx.scale(this.entity.transform.scaleX,this.entity.transform.scaleY);
    const img=Assets.getImage(this.sprite);
    if(img){ ctx.drawImage(img,-img.width/2,-img.height/2); }
    else { ctx.fillStyle=this.color; ctx.fillRect(-16,-16,32,32); }
    ctx.restore();
  }
}

class RigidBody {
  constructor(entity,{velocity=new Vector2(0,0),gravity=0,friction=0.9}={}){this.entity=entity;this.type='RigidBody';this.velocity=velocity;this.gravity=gravity;this.friction=friction;this.onGround=false;}
  update(dt){
    this.velocity.y += this.gravity*dt;
    this.entity.transform.x += this.velocity.x*dt;
    this.entity.transform.y += this.velocity.y*dt;
    this.velocity.x *= this.friction;
    // Simple ground clamp
    if(this.entity.transform.y>360){this.entity.transform.y=360;this.velocity.y=0;this.onGround=true;}
  }
}

class BoxCollider {
  constructor(entity,{w=32,h=32}={}){this.entity=entity;this.type='BoxCollider';this.w=w;this.h=h;}
  getRect(){return new Rect(this.entity.transform.x - this.w/2, this.entity.transform.y - this.h/2, this.w, this.h);}
}

class ScriptComponent {
  constructor(entity,{behavior={}}={}){this.entity=entity;this.behavior=behavior;this.type='Script';}
  start(){this.behavior.onStart&&this.behavior.onStart(this.entity,{Engine,Scene,Entity,Components});}
  update(dt){this.behavior.onUpdate&&this.behavior.onUpdate(this.entity,dt,{Engine,Scene,Entity,Components});}
  onCollisionEnter(other){this.behavior.onCollisionEnter&&this.behavior.onCollisionEnter(this.entity,other);}
}

class KeyboardInput {
  constructor(entity){this.entity=entity; this.type='KeyboardInput'; this.left=false; this.right=false; this.jump=false; this._bind(); }
  _bind(){
    window.addEventListener('keydown',(e)=>{if(['ArrowLeft','a','A'].includes(e.key)) this.left=true; if(['ArrowRight','d','D'].includes(e.key)) this.right=true; if(['ArrowUp','w','W',' '].includes(e.key)) this.jump=true;});
    window.addEventListener('keyup',(e)=>{if(['ArrowLeft','a','A'].includes(e.key)) this.left=false; if(['ArrowRight','d','D'].includes(e.key)) this.right=false; if(['ArrowUp','w','W',' '].includes(e.key)) this.jump=false;});
  }
}

const Components = { SpriteRenderer, RigidBody, BoxCollider, ScriptComponent, KeyboardInput };

// Helpers
const helpers = {
  populateScene(data, scene){
    data.forEach(d=>{
      const ent=new Entity(d.name);
      ent.transform.x=d.x; ent.transform.y=d.y; ent.transform.rotation=d.rotation; ent.transform.scaleX=d.scaleX; ent.transform.scaleY=d.scaleY;
      ent.addComponent('SpriteRenderer',{sprite:d.sprite});
      if(d.collider) ent.addComponent('BoxCollider',{w:d.collider.w,h:d.collider.h});
      if(d.script && scriptModules[d.script]) ent.addComponent('Script',{behavior:scriptModules[d.script]});
      scene.addEntity(ent);
    });
  }
};

const scriptModules = {};
function registerMain(fn){ window.__userMain = fn; }

function loadScripts(){
  Object.entries(projectFiles).forEach(([name,code])=>{
    const module = { exports: {} };
    try {
      new Function('Engine','Scene','Entity','Components','Assets','registerMain','initialScene','helpers','module','exports', code)(Engine,Scene,Entity,Components,Assets,registerMain,initialScene,helpers,module,module.exports);
      scriptModules[name] = module.exports;
    } catch(err){ console.error('Script error', name, err); }
  });
}

loadScripts();
if(typeof __userMain === 'function') { __userMain({Engine,Scene,Entity,Components,Assets,initialScene,helpers}); }
</script></body></html>`;
    }

    // UI bindings
    document.getElementById('save-btn').onclick = saveCurrent;
    document.getElementById('add-file-btn').onclick = () => {
      const name = prompt('File name (e.g. enemy.js):','newScript.js');
      if (!name) return;
      if (projectFiles[name]) return alert('File exists');
      projectFiles[name] = '// New script\n';
      activeFile = name;
      renderTabs();
      loadFile(name);
    };
    document.getElementById('new-entity-btn').onclick = addEntity;
    document.getElementById('play-btn').onclick = playGame;
    document.getElementById('stop-btn').onclick = stopGame;

    initCodeEditor();
    renderTabs();
    renderAssets();
    renderHierarchy();
    renderInspector();
  </script>
</body>
</html>
