<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini 2D Game Engine & IDE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-2: #111827;
      --border: #1f2937;
      --accent: #38bdf8;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.08), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(37,99,235,0.08), transparent 25%),
                  var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
    }
    header h1 { margin: 0; font-size: 18px; letter-spacing: 0.5px; }
    header .tag { background: rgba(56,189,248,0.12); color: var(--accent); padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    main {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1.4fr;
      gap: 12px;
      padding: 12px;
      height: calc(100vh - 64px);
      overflow: hidden;
    }
    .panel {
      background: linear-gradient(160deg, rgba(17,24,39,0.95), rgba(15,23,42,0.95));
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel h3 {
      margin: 0;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .toolbar {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }
    .btn {
      background: #0b1629;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      transition: transform 120ms ease, background 120ms ease, border 120ms ease;
    }
    .btn:hover { background: #152238; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.play { background: var(--success); color: #0b1220; border-color: #16a34a; }
    .btn.stop { background: var(--danger); color: #fff; border-color: #b91c1c; }
    .btn.small { padding: 6px 10px; font-size: 12px; }
    #editor-tabs { display: flex; gap: 8px; padding: 10px 12px; border-bottom: 1px solid var(--border); overflow-x: auto; }
    #editor-tabs button {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    #editor-tabs button.active { background: var(--accent); color: #0b1220; border-color: #0ea5e9; }
    #code { flex: 1; min-height: 0; }
    .CodeMirror { height: 100%; background: #0b1220; color: #e2e8f0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .CodeMirror-gutters { background: #0b1220; border-right: 1px solid var(--border); }
    #file-actions { display: flex; gap: 8px; padding: 10px 12px; border-top: 1px solid var(--border); }
    #assets { padding: 10px 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(110px,1fr)); gap: 10px; }
    .asset-card { border: 1px solid var(--border); border-radius: 10px; padding: 8px; background: #0b1220; text-align: center; }
    .asset-card img { width: 72px; height: 72px; border-radius: 8px; border: 1px solid var(--border); object-fit: cover; }
    #hierarchy { flex: 1; overflow: auto; padding: 10px 12px; }
    #hierarchy ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    #hierarchy li { padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #0b1220; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
    #hierarchy li.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(56,189,248,0.2); }
    #inspector { flex: 1; overflow: auto; padding: 10px 12px; display: grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap: 10px; }
    #inspector label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    #inspector input, #inspector select { width: 100%; background: #0b1220; border: 1px solid var(--border); border-radius: 8px; padding: 8px; color: var(--text); }
    #game-panel { display: grid; grid-template-rows: 1fr auto; height: 100%; }
    #game-view { background: #0b1220; position: relative; border-bottom: 1px solid var(--border); }
    #game-view iframe { width: 100%; height: 100%; border: none; background: #0b1220; }
    #console { background: #0a0f1a; color: #9ef0a5; font-family: 'Fira Code', monospace; font-size: 12px; padding: 10px; overflow: auto; height: 170px; }
    #console .log { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    #console .warn { color: #fcd34d; }
    #console .error { color: #f87171; }
    .pill { background: rgba(255,255,255,0.06); padding: 4px 8px; border-radius: 8px; color: var(--muted); font-size: 12px; }
    #right h3 { margin: 0; border-top: 1px solid var(--border); }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <h1>Mini 2D Game Engine & IDE</h1>
      <span class="tag">Single HTML</span>
      <span class="tag">Hot Reload</span>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn play" id="play-btn">â–¶ Play</button>
      <button class="btn stop" id="stop-btn">â–  Stop</button>
    </div>
  </header>
  <main>
    <section class="panel" id="left">
      <div id="editor-tabs"></div>
      <div id="code"><textarea id="code-area"></textarea></div>
      <div id="file-actions">
        <button class="btn" id="save-btn">ðŸ’¾ Save</button>
        <button class="btn" id="add-file-btn">âž• New File</button>
      </div>
      <h3>Assets</h3>
      <div id="assets"></div>
    </section>
    <section class="panel" id="middle">
      <div class="toolbar">
        <button class="btn small" id="new-entity-btn">ï¼‹ New Entity</button>
        <span class="pill">Drag to reorder</span>
      </div>
      <div style="display:grid; grid-template-rows: 1fr 1fr; min-height:0;">
        <div>
          <h3>Scene Hierarchy</h3>
          <div id="hierarchy"></div>
        </div>
        <div>
          <h3>Inspector</h3>
          <div id="inspector"></div>
        </div>
      </div>
    </section>
    <section class="panel" id="right">
      <div id="game-panel">
        <div id="game-view"></div>
        <h3>Console</h3>
        <div id="console"></div>
      </div>
    </section>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script>
    // --- Virtual project files ---
    const projectFiles = {
      'main.js': `// Main entry\nregisterMain(({ Engine, Scene, Entity, Components, Assets, helpers, initialScene }) => {\n  const canvas = document.getElementById('game');\n  const scene = new Scene('Demo');\n  helpers.populateScene(initialScene, scene);\n  Engine.start(canvas, scene);\n});`,
      'player.js': `// Player movement script\nexports.onStart = (entity, { Components }) => {\n  entity.addComponent('RigidBody', { gravity: 900, friction: 0.85 });\n  entity.addComponent('KeyboardInput', {});\n};\n\nexports.onUpdate = (entity, dt) => {\n  const rb = entity.getComponent('RigidBody');\n  const input = entity.getComponent('KeyboardInput');\n  const move = 220;\n  if (input.isDown('ArrowLeft') || input.isDown('KeyA')) rb.velocity.x = -move;\n  if (input.isDown('ArrowRight') || input.isDown('KeyD')) rb.velocity.x = move;\n  if ((input.isDown('ArrowUp') || input.isDown('Space') || input.isDown('KeyW')) && rb.onGround) {\n    rb.velocity.y = -420;\n    rb.onGround = false;\n  }\n};`,
      'hay.js': `// Hay bale behavior\nexports.onStart = (entity) => { entity.isHay = true; };\nexports.onCollisionEnter = (self, other, scene) => {\n  if (other.name === 'Player') {\n    scene.removeEntity(self);\n    scene.money = (scene.money || 0) + 1;\n    console.log('Hay collected! Money: ' + scene.money);\n  }\n};`
    };

    const assetStore = [
      { name: 'player', url: 'https://dummyimage.com/96x96/38bdf8/0b1220&text=P' },
      { name: 'hay', url: 'https://dummyimage.com/96x96/f59e0b/0b1220&text=H' },
      { name: 'ground', url: 'https://dummyimage.com/96x32/22c55e/0b1220&text=G' }
    ];

    // --- Editor State ---
    let currentFile = 'main.js';
    let editor = null;
    let iframe = null;
    let selectedEntityId = null;
    let sceneData = {
      entities: [
        { id: 'player', name: 'Player', transform: { x: 120, y: 220, rotation: 0, scaleX: 1, scaleY: 1 }, components: { SpriteRenderer: { color: '#38bdf8', width: 40, height: 40, sprite: 'player' }, BoxCollider: { width: 36, height: 36 }, Script: { file: 'player.js' } } },
        { id: 'hay1', name: 'Hay 1', transform: { x: 340, y: 260, rotation: 0, scaleX: 1, scaleY: 1 }, components: { SpriteRenderer: { color: '#f59e0b', width: 40, height: 40, sprite: 'hay' }, BoxCollider: { width: 36, height: 36 }, Script: { file: 'hay.js' } } },
        { id: 'hay2', name: 'Hay 2', transform: { x: 420, y: 260, rotation: 0, scaleX: 1, scaleY: 1 }, components: { SpriteRenderer: { color: '#f59e0b', width: 40, height: 40, sprite: 'hay' }, BoxCollider: { width: 36, height: 36 }, Script: { file: 'hay.js' } } },
        { id: 'hay3', name: 'Hay 3', transform: { x: 500, y: 260, rotation: 0, scaleX: 1, scaleY: 1 }, components: { SpriteRenderer: { color: '#f59e0b', width: 40, height: 40, sprite: 'hay' }, BoxCollider: { width: 36, height: 36 }, Script: { file: 'hay.js' } } },
        { id: 'ground', name: 'Ground', transform: { x: 320, y: 320, rotation: 0, scaleX: 7, scaleY: 1 }, components: { SpriteRenderer: { color: '#22c55e', width: 60, height: 20, sprite: 'ground' }, BoxCollider: { width: 420, height: 20 }, RigidBody: { gravity: 0, friction: 1 } } }
      ]
    };

    // --- Editor Helpers ---
    function initEditor() {
      renderTabs();
      editor = CodeMirror.fromTextArea(document.getElementById('code-area'), {
        mode: 'javascript',
        lineNumbers: true,
        theme: 'default'
      });
      editor.setValue(projectFiles[currentFile]);
      editor.on('change', debounce(() => projectFiles[currentFile] = editor.getValue(), 150));
      renderAssets();
      renderHierarchy();
      renderInspector();
    }

    function debounce(fn, t){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a), t); }; }

    function renderTabs() {
      const tabs = document.getElementById('editor-tabs');
      tabs.innerHTML = '';
      Object.keys(projectFiles).forEach(file => {
        const btn = document.createElement('button');
        btn.textContent = file;
        if (file === currentFile) btn.classList.add('active');
        btn.onclick = () => { saveCurrent(); currentFile = file; renderTabs(); editor.setValue(projectFiles[file]); };
        tabs.appendChild(btn);
      });
    }

    function saveCurrent() { if (editor) projectFiles[currentFile] = editor.getValue(); }

    document.getElementById('save-btn').onclick = saveCurrent;
    document.getElementById('add-file-btn').onclick = () => {
      const name = prompt('File name (e.g., enemy.js)');
      if (!name) return;
      if (projectFiles[name]) return alert('File exists');
      projectFiles[name] = '// new script';
      currentFile = name;
      renderTabs();
      editor.setValue(projectFiles[name]);
    };

    function renderAssets() {
      const wrap = document.getElementById('assets');
      wrap.innerHTML = '';
      assetStore.forEach(a => {
        const card = document.createElement('div');
        card.className = 'asset-card';
        card.innerHTML = `<img src="${a.url}" alt="${a.name}"><div>${a.name}</div>`;
        wrap.appendChild(card);
      });
    }

    function renderHierarchy() {
      const container = document.getElementById('hierarchy');
      container.innerHTML = '<ul></ul>';
      const ul = container.querySelector('ul');
      sceneData.entities.forEach((e, idx) => {
        const li = document.createElement('li');
        li.draggable = true;
        li.dataset.id = e.id;
        li.innerHTML = `<span>${e.name}</span><span class="pill">${Object.keys(e.components||{}).length} comps</span>`;
        if (selectedEntityId === e.id) li.classList.add('selected');
        li.onclick = () => { selectedEntityId = e.id; renderHierarchy(); renderInspector(); highlightEntity(e.id); };
        li.addEventListener('dragstart', ev => ev.dataTransfer.setData('text/plain', e.id));
        li.addEventListener('dragover', ev => ev.preventDefault());
        li.addEventListener('drop', ev => {
          ev.preventDefault();
          const from = ev.dataTransfer.getData('text/plain');
          const fromIdx = sceneData.entities.findIndex(en => en.id === from);
          const toIdx = idx;
          if (fromIdx >= 0 && toIdx >= 0 && fromIdx !== toIdx) {
            const [item] = sceneData.entities.splice(fromIdx,1);
            sceneData.entities.splice(toIdx,0,item);
            renderHierarchy();
          }
        });
        ul.appendChild(li);
      });
    }

    document.getElementById('new-entity-btn').onclick = () => {
      const id = 'entity_' + Math.random().toString(36).slice(2,6);
      sceneData.entities.push({ id, name: 'Entity ' + sceneData.entities.length, transform: { x: 100, y: 100, rotation: 0, scaleX: 1, scaleY: 1 }, components: { SpriteRenderer: { color: '#94a3b8', width: 32, height: 32 } } });
      selectedEntityId = id;
      renderHierarchy();
      renderInspector();
    };

    function renderInspector() {
      const panel = document.getElementById('inspector');
      panel.innerHTML = '';
      const entity = sceneData.entities.find(e => e.id === selectedEntityId) || sceneData.entities[0];
      if (!entity) return;
      selectedEntityId = entity.id;
      const rows = [
        ['Name', 'text', entity.name, v => entity.name = v],
        ['X', 'number', entity.transform.x, v => entity.transform.x = parseFloat(v)],
        ['Y', 'number', entity.transform.y, v => entity.transform.y = parseFloat(v)],
        ['Rotation', 'number', entity.transform.rotation, v => entity.transform.rotation = parseFloat(v)],
        ['Scale X', 'number', entity.transform.scaleX, v => entity.transform.scaleX = parseFloat(v)],
        ['Scale Y', 'number', entity.transform.scaleY, v => entity.transform.scaleY = parseFloat(v)]
      ];
      rows.forEach(([label, type, value, onChange]) => {
        const wrap = document.createElement('div');
        wrap.innerHTML = `<label>${label}</label><input type="${type}" value="${value}">`;
        wrap.querySelector('input').oninput = e => { onChange(e.target.value); renderHierarchy(); };
        panel.appendChild(wrap);
      });

      // Sprite renderer
      const sr = entity.components.SpriteRenderer || { color: '#94a3b8', width: 32, height: 32 };
      entity.components.SpriteRenderer = sr;
      const spriteWrap = document.createElement('div');
      spriteWrap.style.gridColumn = '1 / span 2';
      spriteWrap.innerHTML = `
        <label>Sprite Renderer</label>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
          <input type="color" value="${sr.color || '#ffffff'}" title="Color">
          <input type="number" value="${sr.width||32}" title="Width">
          <input type="number" value="${sr.height||32}" title="Height">
          <select title="Sprite">${assetStore.map(a=>`<option value="${a.name}" ${sr.sprite===a.name?'selected':''}>${a.name}</option>`).join('')}</select>
        </div>`;
      const [color,width,height,sel] = spriteWrap.querySelectorAll('input,select');
      color.oninput = e => sr.color = e.target.value;
      width.oninput = e => sr.width = parseFloat(e.target.value);
      height.oninput = e => sr.height = parseFloat(e.target.value);
      sel.onchange = e => sr.sprite = e.target.value;
      panel.appendChild(spriteWrap);

      // Collider
      const col = entity.components.BoxCollider || { width: sr.width || 32, height: sr.height || 32 };
      entity.components.BoxCollider = col;
      const colWrap = document.createElement('div');
      colWrap.style.gridColumn = '1 / span 2';
      colWrap.innerHTML = `
        <label>Box Collider</label>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
          <input type="number" value="${col.width||32}" title="Width">
          <input type="number" value="${col.height||32}" title="Height">
        </div>`;
      const [cw,ch] = colWrap.querySelectorAll('input');
      cw.oninput = e => col.width = parseFloat(e.target.value);
      ch.oninput = e => col.height = parseFloat(e.target.value);
      panel.appendChild(colWrap);

      // Script assignment
      const sc = entity.components.Script || { file: '' };
      entity.components.Script = sc;
      const scWrap = document.createElement('div');
      scWrap.style.gridColumn = '1 / span 2';
      scWrap.innerHTML = `
        <label>Script File</label>
        <select>${Object.keys(projectFiles).map(f=>`<option value="${f}" ${sc.file===f?'selected':''}>${f}</option>`).join('')}</select>`;
      scWrap.querySelector('select').onchange = e => sc.file = e.target.value;
      panel.appendChild(scWrap);
    }

    function highlightEntity(id) {
      const items = document.querySelectorAll('#hierarchy li');
      items.forEach(li => li.classList.toggle('selected', li.dataset.id === id));
    }

    // --- Runtime ---
    document.getElementById('play-btn').onclick = runGame;
    document.getElementById('stop-btn').onclick = stopGame;

    function stopGame() {
      if (iframe) iframe.remove();
      iframe = null;
    }

    function runGame() {
      saveCurrent();
      stopGame();
      iframe = document.createElement('iframe');
      iframe.setAttribute('sandbox', 'allow-scripts');
      document.getElementById('game-view').innerHTML = '';
      document.getElementById('game-view').appendChild(iframe);
      const runtimeHTML = buildRuntimeHTML();
      iframe.srcdoc = runtimeHTML;
    }

    function buildRuntimeHTML() {
      const scripts = Object.entries(projectFiles).map(([name, code]) => `// ${name}\n` + code).join('\n\n');
      const assetsJSON = JSON.stringify(assetStore);
      const sceneJSON = JSON.stringify(sceneData);
      return `<!DOCTYPE html><html><head><style>body{margin:0;background:#0b1220;color:#fff;font-family:Inter,sans-serif;}#game{width:100%;height:100%;background:#0b1220;display:block;}canvas{background:#0b1220;}::-webkit-scrollbar{display:none}</style></head><body><canvas id="game"></canvas><script>const parentConsole = parent; const logs=[]; const forward=(type,...args)=>{parentConsole.postMessage({type:'console',level:type,content:args.map(a=>typeof a==='object'?JSON.stringify(a):a).join(' ')},'*');};['log','warn','error'].forEach(k=>{const o=console[k];console[k]=function(...a){forward(k,...a); return o.apply(console,a);};});</script><script>${engineCode()}</script><script>const projectFiles = ${JSON.stringify(projectFiles)}; const assetManifest=${assetsJSON}; const initialScene=${sceneJSON}; ${scripts}; setupRuntime(projectFiles, assetManifest, initialScene);</script></body></html>`;
    }

    window.addEventListener('message', (ev) => {
      if (ev.data?.type === 'console') appendConsole(ev.data.level, ev.data.content);
    });

    function appendConsole(level, msg) {
      const c = document.getElementById('console');
      const div = document.createElement('div');
      div.className = 'log ' + level;
      div.textContent = msg;
      c.appendChild(div);
      c.scrollTop = c.scrollHeight;
    }

    function engineCode() {
      return `(() => {
  // Math utilities
  class Vector2 { constructor(x=0,y=0){this.x=x;this.y=y;} add(v){this.x+=v.x;this.y+=v.y;return this;} clone(){return new Vector2(this.x,this.y);} }
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const distance=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
  class Rect { constructor(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;} intersects(o){return !(this.x>o.x+o.w||this.x+this.w<o.x||this.y>o.y+o.h||this.y+this.h<o.y);} }

  // Asset Manager
  class AssetManager {
    constructor(){this.images=new Map();}
    loadImage(name,url){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>{this.images.set(name,img);res(img);};img.onerror=rej;img.src=url;});}
    getImage(name){return this.images.get(name);} }

  // Components
  class Component { constructor(entity){this.entity=entity;} onStart(){} onUpdate(){} draw(){} }
  class SpriteRenderer extends Component {
    constructor(entity, cfg={}){super(entity);this.color=cfg.color||'#fff';this.width=cfg.width||32;this.height=cfg.height||32;this.sprite=cfg.sprite;}
    draw(ctx){const t=this.entity.transform;ctx.save();ctx.translate(t.x,t.y);ctx.rotate(t.rotation*Math.PI/180);ctx.scale(t.scaleX,t.scaleY);const img=this.entity.scene.assets.getImage(this.sprite);if(img){ctx.drawImage(img,-this.width/2,-this.height/2,this.width,this.height);}else{ctx.fillStyle=this.color;ctx.fillRect(-this.width/2,-this.height/2,this.width,this.height);}ctx.restore();}
  }
  class RigidBody extends Component {
    constructor(entity,cfg={}){super(entity);this.velocity=new Vector2(cfg.vx||0,cfg.vy||0);this.gravity=cfg.gravity??900;this.friction=cfg.friction??0.9;this.onGround=false;}
    onUpdate(dt){this.velocity.y+=this.gravity*dt;this.velocity.x*=this.friction;const t=this.entity.transform;t.x+=this.velocity.x*dt; t.y+=this.velocity.y*dt;}
  }
  class BoxCollider extends Component {
    constructor(entity,cfg={}){super(entity);this.width=cfg.width||32;this.height=cfg.height||32;}
    get rect(){const t=this.entity.transform;return new Rect(t.x-this.width/2,t.y-this.height/2,this.width,this.height);} }
  class KeyboardInput extends Component {
    constructor(entity){super(entity);this.keys=new Set();this._down=e=>this.keys.add(e.code);this._up=e=>this.keys.delete(e.code);window.addEventListener('keydown',this._down);window.addEventListener('keyup',this._up);}
    isDown(code){return this.keys.has(code);} }
  class Script extends Component {
    constructor(entity,cfg={}){super(entity);this.module=cfg.module;}
    onStart(){this.module?.onStart?.(this.entity,{Components,Assets:this.entity.scene.assets});}
    onUpdate(dt){this.module?.onUpdate?.(this.entity,dt,{Components,Assets:this.entity.scene.assets});}
    onCollisionEnter(o){this.module?.onCollisionEnter?.(this.entity,o,this.entity.scene);} onCollisionStay(o){this.module?.onCollisionStay?.(this.entity,o,this.entity.scene);} }

  const Components={SpriteRenderer,RigidBody,BoxCollider,KeyboardInput,Script};

  class Entity {
    constructor(name){this.name=name;this.transform={x:0,y:0,rotation:0,scaleX:1,scaleY:1};this.components=[];this.scene=null;}
    addComponent(type,cfg={}){const C=Components[type];if(!C) throw new Error('Unknown component '+type);const c=new C(this,cfg);this.components.push(c);return c;}
    getComponent(type){return this.components.find(c=>c.constructor.name===type);}    update(dt){this.components.forEach(c=>c.onUpdate?.(dt));}
    draw(ctx){this.components.forEach(c=>c.draw?.(ctx));}
  }

  class Scene {
    constructor(name){this.name=name;this.entities=[];this.assets=null;this.money=0;}
    addEntity(e){e.scene=this;this.entities.push(e);} removeEntity(e){this.entities=this.entities.filter(x=>x!==e);} findByName(n){return this.entities.find(e=>e.name===n);} load(){this.entities.forEach(e=>e.components.forEach(c=>c.onStart?.()));}
    update(dt){for(const e of this.entities) e.update(dt); this.handleCollisions();}
    handleCollisions(){
      this._collisions = this._collisions || new Set();
      const next = new Set();
      const colliders=this.entities.map(e=>({e,col:e.getComponent('BoxCollider')})).filter(c=>c.col);
      for(let i=0;i<colliders.length;i++){
        for(let j=i+1;j<colliders.length;j++){
          const a=colliders[i],b=colliders[j];
          if(a.col.rect.intersects(b.col.rect)){
            const key=a.e.name+'|'+b.e.name;
            next.add(key);
            const already=this._collisions.has(key);
            const call=(method,src,tgt)=>src.components.forEach(c=>c[method]?.(tgt));
            call(already?'onCollisionStay':'onCollisionEnter', a.e, b.e);
            call(already?'onCollisionStay':'onCollisionEnter', b.e, a.e);
            [a,b].forEach(pair=>{
              const other = pair===a?b:a; const rb = pair.e.getComponent('RigidBody');
              if(rb){
                const rect = pair.col.rect; const rectO = other.col.rect;
                const falling = rb.velocity.y >= 0;
                if(falling && rect.y+rect.h/2 <= rectO.y){
                  pair.e.transform.y = rectO.y - pair.col.height/2;
                  rb.velocity.y = 0; rb.onGround = true;
                }
              }
            });
          }
        }
      }
      this._collisions.forEach(key=>{if(!next.has(key)){const [aName,bName]=key.split('|'); const a=this.findByName(aName), b=this.findByName(bName); if(a&&b){a.components.forEach(c=>c.onCollisionStay?.(b));b.components.forEach(c=>c.onCollisionStay?.(a));}}});
      this._collisions = next;
    }
  }

  const Engine = {
    running:false, ctx:null, canvas:null, scene:null, last:0, timeScale:1,
    start(canvas, scene){
      this.canvas=canvas;this.ctx=canvas.getContext('2d');this.scene=scene;this.running=true;
      const resize=()=>{canvas.width=canvas.clientWidth;canvas.height=canvas.clientHeight;};
      window.addEventListener('resize',resize); resize(); scene.load();
      this.last=performance.now(); requestAnimationFrame(this.loop.bind(this));
    },
    stop(){this.running=false;},
    loop(t){if(!this.running) return; const dt=((t-this.last)/1000)*this.timeScale; this.last=t; this.update(dt); requestAnimationFrame(this.loop.bind(this));},
    update(dt){const ctx=this.ctx; ctx.clearRect(0,0,this.canvas.width,this.canvas.height); ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,this.canvas.width,this.canvas.height); this.scene.update(dt); this.scene.entities.forEach(e=>e.draw(ctx));}
  };

  function buildSceneFromData(data, scripts){
    const scene=new Scene('Runtime');
    scene.assets = new AssetManager();
    data.entities.forEach(d=>{
      const e=new Entity(d.name); e.transform={...d.transform};
      scene.addEntity(e);
      if(d.components.SpriteRenderer) e.addComponent('SpriteRenderer', d.components.SpriteRenderer);
      if(d.components.RigidBody) e.addComponent('RigidBody', d.components.RigidBody);
      if(d.components.BoxCollider) e.addComponent('BoxCollider', d.components.BoxCollider);
      if(d.components.KeyboardInput) e.addComponent('KeyboardInput', d.components.KeyboardInput);
      if(d.components.Script){const module=scripts[d.components.Script.file]; e.addComponent('Script',{module});}
    });
    return scene;
  }

  function setupRuntime(files, assets, initialScene){
    const modules={};
    Object.entries(files).forEach(([name,code])=>{if(name==='main.js') return; const exports={}; new Function('exports', code)(exports); modules[name]=exports;});
    const Assets=new AssetManager();
    assets.forEach(a=>Assets.loadImage(a.name,a.url));
    const helpers={populateScene:(data,scene)=>{scene.assets=Assets; const modulesLocal=modules; data.entities.forEach(d=>{const e=new Entity(d.name); e.transform={...d.transform}; scene.addEntity(e); if(d.components.SpriteRenderer) e.addComponent('SpriteRenderer',d.components.SpriteRenderer); if(d.components.RigidBody) e.addComponent('RigidBody',d.components.RigidBody); if(d.components.BoxCollider) e.addComponent('BoxCollider',d.components.BoxCollider); if(d.components.KeyboardInput) e.addComponent('KeyboardInput',d.components.KeyboardInput); if(d.components.Script){const mod=modulesLocal[d.components.Script.file]; e.addComponent('Script',{module:mod});}});};};
    const mainWrapper = new Function('registerMain', files['main.js']);
    mainWrapper((cb)=>cb({Engine,Scene,Entity,Components,Assets,helpers,initialScene}));
  }

  window.setupRuntime=setupRuntime;
})();`;
    }

    window.addEventListener('load', initEditor);
  </script>
</body>
</html>
